install spatial;
load spatial;

create or replace temp table blocks as from st_read('SRCS_Census_Blocks.geojson');

create or replace temp table fixed as
from blocks where GEOID20 not in ('060971521002009', '060971521002016', '060971530011000', '060971523002002', '060971520001010', '060971527021000', '060971527011010', '060971527021009', '060971527021001')
union
-- PTES/HVES
from blocks 
select 
    * exclude (geom),
    st_intersection(geom, ST_GeomFromText('POLYGON ((-122.70196553719893 38.45725354365072, -122.69914147335442 38.455685350058076, -122.69744940509784 38.457168927396225, -122.69947892286415 38.457557747963335, -122.70115214022731 38.457481036083266, -122.70157214310592 38.457673996977576, -122.70196553719893 38.45725354365072))')) as geom
where GEOID20 in ('060971523002002')
union
from blocks 
select 
    * exclude (geom),
    st_difference(geom, ST_GeomFromText('POLYGON ((-122.70196553719893 38.45725354365072, -122.69914147335442 38.455685350058076, -122.69744940509784 38.457168927396225, -122.69947892286415 38.457557747963335, -122.70115214022731 38.457481036083266, -122.70157214310592 38.457673996977576, -122.70196553719893 38.45725354365072))')) as geom
where GEOID20 in ('060971523002002')
union
-- 101 at SRHS
from blocks 
select 
    * exclude (geom),
    st_intersection(geom, ST_GeomFromText('POLYGON ((-122.72566493709935 38.456117091410505, -122.72670944753489 38.45594806308205, -122.72682872961127 38.44468576521979, -122.7217053801265 38.445162792236545, -122.72438557213364 38.45580792488721, -122.72566493709935 38.456117091410505))')) as geom
where GEOID20 in ('060971521002009', '060971521002016', '060971530011000')
union
from blocks 
select 
    * exclude (geom),
    st_difference(geom, ST_GeomFromText('POLYGON ((-122.72566493709935 38.456117091410505, -122.72670944753489 38.45594806308205, -122.72682872961127 38.44468576521979, -122.7217053801265 38.445162792236545, -122.72438557213364 38.45580792488721, -122.72566493709935 38.456117091410505))')) as geom
where GEOID20 in ('060971521002009', '060971521002016', '060971530011000')
union
-- 101 at Morgan St
from blocks 
select 
    * exclude (geom),
    st_intersection(geom, ST_GeomFromText('POLYGON ((-122.719878 38.441147,-122.71846013485258 38.43927438893693,-122.71929829894796 38.43878525061229,-122.72066708730719 38.44083482838688,-122.720073 38.441062,-122.719878 38.441147))')) as geom
where GEOID20 in ('060971520001010')
union
from blocks 
select 
    * exclude (geom),
    st_difference(geom, ST_GeomFromText('POLYGON ((-122.719878 38.441147,-122.71846013485258 38.43927438893693,-122.71929829894796 38.43878525061229,-122.72066708730719 38.44083482838688,-122.720073 38.441062,-122.719878 38.441147))')) as geom
where GEOID20 in ('060971520001010')
union
-- Riebli boundary
from blocks 
select 
    * exclude (geom),
    st_intersection(geom, ST_MakeValid(ST_GeomFromText('MULTIPOLYGON (((-122.74097286750984 38.49970214096089, -122.73441863176515 38.49155286925759, -122.71897013178331 38.49129560199469, -122.71252777859935 38.53254952668732, -122.7380342381438 38.53702328180779, -122.74459945307906 38.5338259335104, -122.74461870879988 38.53151347398125, -122.74422573613046 38.528654231912896, -122.73990447033809 38.52114330172367, -122.74052252283482 38.50418843338795, -122.7409172528192 38.50002842691396, -122.74097286750984 38.49970214096089), (-122.75862378323164 38.50258508844131, -122.7505318182761 38.50050135588202, -122.75016938186035 38.50079844499537, -122.75004858691175 38.50098740717512, -122.74972932985833 38.50159495373488, -122.74959996710989 38.50165519158088, -122.74937576034958 38.50201204266179, -122.74928597624334 38.50215186944161, -122.74923071087301 38.50232208675574, -122.74868869593085 38.50342565875829, -122.74854174016794 38.50366003429043, -122.74847245156126 38.50377285004332, -122.74803615024832 38.504552252986834, -122.75334437217201 38.51004493597384, -122.75972353285283 38.50610671276473, -122.75862378323164 38.50258508844131)))'))) as geom
where GEOID20 in ('060971527021000', '060971527011010', '060971527021009', '060971527021001')
union
from blocks 
select 
    * exclude (geom),
    st_difference(geom, ST_MakeValid(ST_GeomFromText('MULTIPOLYGON (((-122.74097286750984 38.49970214096089, -122.73441863176515 38.49155286925759, -122.71897013178331 38.49129560199469, -122.71252777859935 38.53254952668732, -122.7380342381438 38.53702328180779, -122.74459945307906 38.5338259335104, -122.74461870879988 38.53151347398125, -122.74422573613046 38.528654231912896, -122.73990447033809 38.52114330172367, -122.74052252283482 38.50418843338795, -122.7409172528192 38.50002842691396, -122.74097286750984 38.49970214096089), (-122.75862378323164 38.50258508844131, -122.7505318182761 38.50050135588202, -122.75016938186035 38.50079844499537, -122.75004858691175 38.50098740717512, -122.74972932985833 38.50159495373488, -122.74959996710989 38.50165519158088, -122.74937576034958 38.50201204266179, -122.74928597624334 38.50215186944161, -122.74923071087301 38.50232208675574, -122.74868869593085 38.50342565875829, -122.74854174016794 38.50366003429043, -122.74847245156126 38.50377285004332, -122.74803615024832 38.504552252986834, -122.75334437217201 38.51004493597384, -122.75972353285283 38.50610671276473, -122.75862378323164 38.50258508844131)))'))) as geom
where GEOID20 in ('060971527021000', '060971527011010', '060971527021009', '060971527021001')
;

copy (from (from fixed select * exclude geom, unnest(st_dump(geom), recursive := true) as geom) select * exclude path) to 'SRCS_Census_Blocks_Fixed.geojson' (format GDAL, driver 'GeoJSON');