install spatial;
load spatial;

create or replace temp table blocks as from st_read('SRCS_Census_Blocks.geojson');

create or replace temp table fixed as
from blocks where GEOID20 not in ('060971521002009', '060971521002016', '060971530011000', '060971523002002', '060971520001010', '060971527021000', '060971527011010', '060971527021009', '060971527021001')
union
-- PTES/HVES
from blocks 
select 
    * exclude (geom),
    st_intersection(geom, ST_GeomFromText('POLYGON ((-122.70196553719893 38.45725354365072, -122.69914147335442 38.455685350058076, -122.69744940509784 38.457168927396225, -122.69947892286415 38.457557747963335, -122.70115214022731 38.457481036083266, -122.70157214310592 38.457673996977576, -122.70196553719893 38.45725354365072))')) as geom
where GEOID20 in ('060971523002002')
union
from blocks 
select 
    * exclude (geom),
    st_difference(geom, ST_GeomFromText('POLYGON ((-122.70196553719893 38.45725354365072, -122.69914147335442 38.455685350058076, -122.69744940509784 38.457168927396225, -122.69947892286415 38.457557747963335, -122.70115214022731 38.457481036083266, -122.70157214310592 38.457673996977576, -122.70196553719893 38.45725354365072))')) as geom
where GEOID20 in ('060971523002002')
union
-- 101 at SRHS
from blocks 
select 
    * exclude (geom),
    st_intersection(geom, ST_GeomFromText('POLYGON ((-122.72566493709935 38.456117091410505, -122.72670944753489 38.45594806308205, -122.72682872961127 38.44468576521979, -122.7217053801265 38.445162792236545, -122.72438557213364 38.45580792488721, -122.72566493709935 38.456117091410505))')) as geom
where GEOID20 in ('060971521002009', '060971521002016', '060971530011000')
union
from blocks 
select 
    * exclude (geom),
    st_difference(geom, ST_GeomFromText('POLYGON ((-122.72566493709935 38.456117091410505, -122.72670944753489 38.45594806308205, -122.72682872961127 38.44468576521979, -122.7217053801265 38.445162792236545, -122.72438557213364 38.45580792488721, -122.72566493709935 38.456117091410505))')) as geom
where GEOID20 in ('060971521002009', '060971521002016', '060971530011000')
union
-- 101 at Morgan St
from blocks 
select 
    * exclude (geom),
    st_intersection(geom, ST_GeomFromText('POLYGON ((-122.719878 38.441147,-122.71846013485258 38.43927438893693,-122.71929829894796 38.43878525061229,-122.72066708730719 38.44083482838688,-122.720073 38.441062,-122.719878 38.441147))')) as geom
where GEOID20 in ('060971520001010')
union
from blocks 
select 
    * exclude (geom),
    st_difference(geom, ST_GeomFromText('POLYGON ((-122.719878 38.441147,-122.71846013485258 38.43927438893693,-122.71929829894796 38.43878525061229,-122.72066708730719 38.44083482838688,-122.720073 38.441062,-122.719878 38.441147))')) as geom
where GEOID20 in ('060971520001010')
union
-- Riebli boundary
from blocks 
select 
    * exclude (geom),
    st_intersection(geom, ST_ReducePrecision(ST_GeomFromText('POLYGON ((-122.73944365367768 38.49949369251513, -122.73274814046268 38.50413096624192, -122.74165989677516 38.52540883338028, -122.74234334864627 38.52737974997396, -122.74260841870101 38.528436650111445, -122.74253746326153 38.52971208748281, -122.74295592581385 38.53195392195107, -122.74310420620456 38.53375890529556, -122.74528296694571 38.533958940308935, -122.77007443480932 38.53431504036183, -122.76969896767162 38.503254094512386, -122.75066590887513 38.50051987347638, -122.75019993946961 38.50082993382182, -122.74995407284105 38.50114721961397, -122.74972379412516 38.501596661546074, -122.74956460301385 38.50168024600333, -122.74944219136961 38.5020178195268, -122.74927517673228 38.50214831857477, -122.74921739911721 38.50240533472012, -122.74892425840733 38.50283098878069, -122.74868467779832 38.50345783437055, -122.74846449993028 38.50373997822598, -122.74799946512533 38.50432162411991, -122.74221299180033 38.50418817375444, -122.73944365367768 38.49949369251513))'), 0.000001)) as geom
where GEOID20 in ('060971527021000', '060971527011010', '060971527021009', '060971527021001')
union
from blocks 
select 
    * exclude (geom),
    st_difference(geom, ST_ReducePrecision(ST_GeomFromText('POLYGON ((-122.73944365367768 38.49949369251513, -122.73274814046268 38.50413096624192, -122.74165989677516 38.52540883338028, -122.74234334864627 38.52737974997396, -122.74260841870101 38.528436650111445, -122.74253746326153 38.52971208748281, -122.74295592581385 38.53195392195107, -122.74310420620456 38.53375890529556, -122.74528296694571 38.533958940308935, -122.77007443480932 38.53431504036183, -122.76969896767162 38.503254094512386, -122.75066590887513 38.50051987347638, -122.75019993946961 38.50082993382182, -122.74995407284105 38.50114721961397, -122.74972379412516 38.501596661546074, -122.74956460301385 38.50168024600333, -122.74944219136961 38.5020178195268, -122.74927517673228 38.50214831857477, -122.74921739911721 38.50240533472012, -122.74892425840733 38.50283098878069, -122.74868467779832 38.50345783437055, -122.74846449993028 38.50373997822598, -122.74799946512533 38.50432162411991, -122.74221299180033 38.50418817375444, -122.73944365367768 38.49949369251513))'), 0.000001)) as geom
where GEOID20 in ('060971527021000', '060971527011010', '060971527021009', '060971527021001')
;

copy (from (from fixed select * exclude geom, unnest(st_dump(geom), recursive := true) as geom) select * exclude path) to 'SRCS_Census_Blocks_Fixed.geojson' (format GDAL, driver 'GeoJSON');