install spatial;
load spatial;

create or replace temp table blocks as from st_read('SRCS_Census_Blocks.geojson');

create or replace temp table fixed as
from blocks where GEOID20 not in ('060971521002009', '060971521002016', '060971530011000', '060971523002002', '060971520001010', '060971527021000', '060971527011010', '060971527021009', '060971527021001')
union
-- PTES/HVES
from blocks 
select 
    * exclude (geom),
    st_intersection(geom, ST_GeomFromText('POLYGON ((-122.70196553719893 38.45725354365072, -122.69914147335442 38.455685350058076, -122.69744940509784 38.457168927396225, -122.69947892286415 38.457557747963335, -122.70115214022731 38.457481036083266, -122.70157214310592 38.457673996977576, -122.70196553719893 38.45725354365072))')) as geom
where GEOID20 in ('060971523002002')
union
from blocks 
select 
    * exclude (geom),
    st_difference(geom, ST_GeomFromText('POLYGON ((-122.70196553719893 38.45725354365072, -122.69914147335442 38.455685350058076, -122.69744940509784 38.457168927396225, -122.69947892286415 38.457557747963335, -122.70115214022731 38.457481036083266, -122.70157214310592 38.457673996977576, -122.70196553719893 38.45725354365072))')) as geom
where GEOID20 in ('060971523002002')
union
-- 101 at SRHS
from blocks 
select 
    * exclude (geom),
    st_intersection(geom, ST_GeomFromText('POLYGON ((-122.72566493709935 38.456117091410505, -122.72670944753489 38.45594806308205, -122.72682872961127 38.44468576521979, -122.7217053801265 38.445162792236545, -122.72438557213364 38.45580792488721, -122.72566493709935 38.456117091410505))')) as geom
where GEOID20 in ('060971521002009', '060971521002016', '060971530011000')
union
from blocks 
select 
    * exclude (geom),
    st_difference(geom, ST_GeomFromText('POLYGON ((-122.72566493709935 38.456117091410505, -122.72670944753489 38.45594806308205, -122.72682872961127 38.44468576521979, -122.7217053801265 38.445162792236545, -122.72438557213364 38.45580792488721, -122.72566493709935 38.456117091410505))')) as geom
where GEOID20 in ('060971521002009', '060971521002016', '060971530011000')
union
-- 101 at Morgan St
from blocks 
select 
    * exclude (geom),
    st_intersection(geom, ST_GeomFromText('POLYGON ((-122.719878 38.441147,-122.71846013485258 38.43927438893693,-122.71929829894796 38.43878525061229,-122.72066708730719 38.44083482838688,-122.720073 38.441062,-122.719878 38.441147))')) as geom
where GEOID20 in ('060971520001010')
union
from blocks 
select 
    * exclude (geom),
    st_difference(geom, ST_GeomFromText('POLYGON ((-122.719878 38.441147,-122.71846013485258 38.43927438893693,-122.71929829894796 38.43878525061229,-122.72066708730719 38.44083482838688,-122.720073 38.441062,-122.719878 38.441147))')) as geom
where GEOID20 in ('060971520001010')
union
-- Riebli boundary
from blocks 
select 
    * exclude (geom),
    st_intersection(geom, ST_GeomFromText('POLYGON ((-122.74221 38.50419, -122.74794124241474 38.50430467285843, -122.74846 38.50374, -122.74868 38.50346, -122.74892 38.50283, -122.74922 38.50241, -122.74928 38.50215, -122.74944 38.50202, -122.74956 38.50168, -122.74972 38.5016, -122.74995 38.50115, -122.7502 38.50083, -122.75067 38.50052, -122.7697 38.50325, -122.77007 38.53432, -122.74319975862153 38.537646053612946, -122.7430726908247 38.52822041648934, -122.74166 38.52541, -122.73260694440852 38.50414243889358, -122.73944 38.49949, -122.74221 38.50419))')) as geom
where GEOID20 in ('060971527021000', '060971527011010', '060971527021009', '060971527021001')
union
from blocks 
select 
    * exclude (geom),
    st_difference(geom, ST_GeomFromText('POLYGON ((-122.74221 38.50419, -122.74794124241474 38.50430467285843, -122.74846 38.50374, -122.74868 38.50346, -122.74892 38.50283, -122.74922 38.50241, -122.74928 38.50215, -122.74944 38.50202, -122.74956 38.50168, -122.74972 38.5016, -122.74995 38.50115, -122.7502 38.50083, -122.75067 38.50052, -122.7697 38.50325, -122.77007 38.53432, -122.74319975862153 38.537646053612946, -122.7430726908247 38.52822041648934, -122.74166 38.52541, -122.73260694440852 38.50414243889358, -122.73944 38.49949, -122.74221 38.50419))')) as geom
where GEOID20 in ('060971527021000', '060971527011010', '060971527021009', '060971527021001')
;

copy (from (from fixed select * exclude geom, unnest(st_dump(geom), recursive := true) as geom) select * exclude path order by GEOID20) to 'SRCS_Census_Blocks_Fixed.geojson' (format GDAL, driver 'GeoJSON');
